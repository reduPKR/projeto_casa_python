{% extends "model-page.html" %}

{% block content %}
    <div align='center'>
        <br>
        <h3><i class="fas fa-stopwatch-20"></i> Temporizador </h3><br>
        <div class="container">
            <div class="row">
                <div class="col col-7 col-sm-7 col-md-45col-lg-7 col-xs-5 container box-gray">
                    <br>
                    <label>Tempo para proxima leitura  <span id="time"></span> minutos!</label>
                    <br>
                    {% if consumos.gastos %}
                        <table class="table table-striped table-dark">
                             <thead>
                                <tr align="center">
                                    {% for titulo in consumos.titulos %}
                                        <th>
                                            {{titulo}}
                                        </th>
                                    {% endfor %}
                                </tr>
                             </thead>
                            {% for gastos in consumos.gastos %}
                                <tr>
                                    {% for gasto in gastos %}
                                        <td>
                                            {{gasto}}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </table>
                    {% endif %}
                    <br>
                    <a type="button" class="btn btn-warning" style="position: absolute; left: 10px;" href="/simular/selecionar/meta?casa_id={{casa.id}}">
                        <i class='fas fa-arrow-alt-circle-left'></i> Voltar
                    </a><br><br>
                </div>
            </div>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script>
    let dia = 1;
    let hora = 0;

    window.onload = function () {
        var tempo = JSON.parse('{{ tempo|safe }}');
        var minutos = 60 * tempo,
            display = document.querySelector('#time');

        ler_dados();
        Timer(minutos, display);
    };

    function Timer(duracao, display) {
        var timer = duracao, minutos, segundos;
        setInterval(function () {
            minutos = parseInt(timer / 60, 10);
            segundos = parseInt(timer % 60, 10);

            minutos = minutos < 10 ? "0" + minutos : minutos;
            segundos = segundos < 10 ? "0" + segundos : segundos;

            display.textContent = minutos + ":" + segundos;

            timer = timer-29
            if (--timer < 0) {
                timer = duracao;

                ler_dados();
                if(hora == 24){
                    hora = 0;
                    dia++;
                }
            }
        }, 1000);
    }

    function ler_dados() {
        $.ajax({
            type: "get",
            url: "/simular/selecionar/leitura",
            data: {
                dia: dia,
                hora: hora
            },
            dataType: "json",
            success: function(result){
                console.log(result)
            }
        });
        hora++;
    }

</script>
{% endblock %}